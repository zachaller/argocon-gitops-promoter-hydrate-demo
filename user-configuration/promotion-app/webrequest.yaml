apiVersion: promoter.argoproj.io/v1alpha1
kind: WebRequestCommitStatus
metadata:
  name: change-management-approval
  namespace: default
  labels:
    test: test2
spec:
  descriptionTemplate: Check for approved change records in current time window
  expression: |
    Response.StatusCode == 200 &&
    len(Response.Body.change_records) > 0 &&
    any(Response.Body.change_records, {
      date(#.change_request.start_time) <= now() &&
      date(#.change_request.end_time) >= now()
    })
  httpRequest:
    headerTemplates:
      Accept: application/json
    method: GET
    timeout: 30s
    urlTemplate: http://localhost:8987/v1/change-management-service/changes/search?asset_id=1372489579564901493&commit_id={{.Environment.Proposed.Dry.Sha }}&status=CLOSED_SUCCESS&limit=25
  key: change-management-approval
  mode:
    trigger:
      triggerExpression: |
        // Current state
        let currentDrySha = Environment.Proposed.Dry.Sha;
        let lastCheckedDrySha = TriggerData.lastCheckedDrySha ?? "";
        let hasOpenPR = Environment.PullRequest != nil &&
                        string(Environment.PullRequest.State) == "open";

        // New dry SHA we haven't checked yet?
        let isNewDrySha = currentDrySha != lastCheckedDrySha;

        // Already checked this SHA but haven't succeeded yet? Need to keep polling
        let needsRetry = currentDrySha == lastCheckedDrySha && Phase != "success";

        // Trigger on new SHA OR if we need to retry (keep polling until success)
        let shouldTrigger = hasOpenPR && (isNewDrySha || needsRetry);

        {
          trigger: shouldTrigger,
          lastCheckedDrySha: currentDrySha
        }
      requeueDuration: 30s
      
      # Extract useful debugging information from search response
      responseExpression: |
        {
          statusCode: Response.StatusCode,
          currentTime: string(now()),
          totalRecordCount: len(Response.Body.change_records ?? []),
          allRecords: map(Response.Body.change_records ?? [], {
            commitId: #.change_request.commit_id ?? "",
            startTime: #.change_request.start_time ?? "",
            endTime: #.change_request.end_time ?? "",
            status: #.change_request.status ?? "",
            environment: #.change_request.environment ?? "",
            withinTimeWindow: (date(#.change_request.start_time) <= now() && date(#.change_request.end_time) >= now())
          }),
          matchingRecords: filter(
            map(Response.Body.change_records ?? [], {
              commitId: #.change_request.commit_id ?? "",
              startTime: #.change_request.start_time ?? "",
              endTime: #.change_request.end_time ?? "",
              status: #.change_request.status ?? "",
              environment: #.change_request.environment ?? "",
              assetId: #.change_request.asset_id ?? ""
            }),
            {
              date(#.startTime) <= now() && date(#.endTime) >= now()
            }
          ),
          matchingCount: len(filter(Response.Body.change_records ?? [], {
            date(#.change_request.start_time) <= now() && date(#.change_request.end_time) >= now()
          })),
          lastCheckedAt: string(now())
        }
  promotionStrategyRef:
    name: argocon-demo
  reportOn: proposed

---
apiVersion: promoter.argoproj.io/v1alpha1
kind: WebRequestCommitStatus
metadata:
  name: change-management-open
  namespace: default
spec:
  descriptionTemplate: Open change request for dry SHA
  expression: |
    Response.StatusCode == 202 &&
    Response.Body != nil &&
    Response.Body.id != nil &&
    Response.Body.id != ""
  httpRequest:
    bodyTemplate: |
      {
        "asset_id": "1372489579564901493",
        "on_behalf_of": "zaller",
        "short_description": "Deploy commit {{ .Environment.Proposed.Dry.Sha }} to {{ .Environment.Branch }} via automated pipeline",
        "description": "Automated deployment of commit {{ .Environment.Proposed.Dry.Sha }} to {{ .Environment.Branch }} for asset 1372489579564901493. Standard deployment following approved change management procedures and best practices for proper change tracking.",
        "environment": "staging",
        "backout_plan": "Rollback to previous version by redeploying previous commit using automated rollback procedure and validation",
        "change_plan": "Standard change roll out using automated deployment pipeline and infrastructure as code with monitoring",
        "test_plan": "Pre-deployment testing completed in lower environments with automated test suite validation and verification",
        "category": "Application",
        "sub_category": "Release",
        "commit_id": "{{ .Environment.Proposed.Dry.Sha }}",
        "start_time": "{{ now | date "2006-01-02T15:04:05Z07:00" }}",
        "end_time": "{{ now | dateModify "+5m" | date "2006-01-02T15:04:05Z07:00" }}",
        "risk": "low",
        "repo_url": "https://github.intuit.com/your-org/your-repo"
      }
    headerTemplates:
      Accept: application/json
      Content-Type: application/json
    method: POST
    timeout: 30s
    urlTemplate: http://localhost:8987/v1/change-management-service/change
  key: change-management-open
  mode:
    trigger:
      triggerExpression: |
        // Current state
        let currentDrySha = Environment.Proposed.Dry.Sha;
        let lastRequestedDrySha = TriggerData.lastRequestedDrySha ?? "";
        let hasOpenPR = Environment.PullRequest != nil &&
                        string(Environment.PullRequest.State) == "open";

        // New dry SHA we haven't tried yet?
        let isNewDrySha = currentDrySha != lastRequestedDrySha;

        // Should we retry? Only for transient errors
        let lastStatusCode = ResponseData != nil ? ResponseData.statusCode : 0;
        let isRetryable = lastStatusCode == 429 || lastStatusCode >= 500;
        let needsRetry = currentDrySha == lastRequestedDrySha &&
                         Phase != "success" &&
                         isRetryable;

        // Trigger on new SHA OR retryable failure
        let shouldTrigger = hasOpenPR && (isNewDrySha || needsRetry);

        {
          trigger: shouldTrigger,
          lastRequestedDrySha: shouldTrigger ? currentDrySha : lastRequestedDrySha
        }
      requeueDuration: 30s

      # Extract useful debugging information from create response
      responseExpression: |
        {
          statusCode: Response.StatusCode,
          changeId: Response.Body.id ?? "",
          message: Response.Body.message ?? "",
          commitId: Response.Body.change_request.commit_id ?? "",
          startTime: Response.Body.change_request.start_time ?? "",
          endTime: Response.Body.change_request.end_time ?? "",
          environment: Response.Body.change_request.environment ?? "",
          assetId: Response.Body.change_request.asset_id ?? "",
          lastRequestedAt: string(now())
        }
  promotionStrategyRef:
    name: argocon-demo
  reportOn: proposed
